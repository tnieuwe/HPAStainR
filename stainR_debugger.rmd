---
title: "stainR Markdown"
author: "Tim Nieuwenhuis"
date: "3/11/2020"
output: html_document
---


#Goals before shiny app:
Add tissue based information for what tissues are being hit and which ones aren't for cell types

Give option of counts or percent

Subset high medium or low genes


#####Columns to add
gene_high
genes_low
genes_medium
tissue hits

high count medium count low count

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(tidyverse)
library(scales)
```

Load data

```{r cars}
hpa_dat <- read.table("normal_tissue.tsv", sep = "\t", header = TRUE, stringsAsFactors = F)
cancer_dat <- read.table("pathology.tsv", sep = "\t", header = TRUE, stringsAsFactors = F)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
### Set up variable for debugging
# gene_list <- c("PRSS1", "CELA3A", "PNLIP", "CELA3A", "PRL")

gene_list <- c("FGF10,FGD5,GSC,DPT,LOC107987373,HAND2,ALDH1A2,DDX43,MCF2L,CNTNAP3B,FGF9,HAND2-AS1,CNTNAP3,GSC-DT,DDO,SULT1A3,HOXD8,CNTNAP3C,SPESP1,HOXD4,SIK1B,PNLDC1,LOC105374809,LOC101930100,KTI12,RGPD2,ADH1B,PRIMA1,NKX6-1,PGR,NOTCH2NLR,EYA4,ZNF257,ENPP5,HTR2A,IRX6,ZNF208,SLC24A3,LOC107986655,GALNT13,ACSS3,LIMS4,LAMA1,PDGFD,MSX2,GRM1,CYP4X1,CHMP1B2P,LOC105369812,NDNF,HEY2,RENBP,RHOU,CCND2-AS1,CASP1,GNA14,LOC100129455,LOC105375249,GABRB3,NRN1,GUCY1A2,USP32P1,PALMD,HLA-DPA1,OGN,LRRC4C,ELMO1,HOXD-AS2,GPM6B,PHACTR1,BARX1,LGR5,LOC107987464,ZNF385B,LINC01116,ADGRD1,LOC112268318,NOVA1,ACKR4,TMEM140,LOC100507516,LOC107984270,CD79B,MAB21L1,ARHGAP20,GBP2,CADM3,TENT5C,LAMA2,LOC105379271,TBX18,KYNU,SPRY1,LHX9,RERG,RSPO3,CTTNBP2,TLR4,LY75,RTP4,LBP,KIT,LRRC2,ADGRL2,CNTNAP3P2,LOC107987413,GLDN,SHOX2,PCDHA6,PLAAT4,LOC105373085,PPL,NTN1,PPARG,S1PR1,LOC101927999,GPR27,GDF7,RTN1,ABCB4,KCNK15,SFRP4,CRACD,CPAMD8,PLXNC1,LMO2,CLIC6,PCDHB16,SECTM1,LOC105374235,CADPS2,PCDHB3,ANGPTL1,TMEM229B,TBC1D3K,AKR1C3,CYP39A1,LOC100507412,APOL3,PLXDC1,C10orf105,AKAP12,TMEM26,PCDHB4,OSR2,PDE1A,PTGFRN,SHE,FAM198B-AS1,ACSS1,PCSK6,LPAR6,LINC00965,CES1,ICA1,KCCAT333,IFIH1,HOXA13,TMEM132B,OAS2,PTGER4,TNXB,SEMA3E,MEDAG,APOE,IGSF3,NR2F1,HECW2,ADRA2A,LOC102723591,POM121L10P,CERS4,NR3C2,KLF8,PARP10,IL34,LOC101928409,CLSTN2,POM121L9P,ASPN,OMD,PSMB9,HOTAIR,IL15RA,OSR1,MX1,ZNF727,CCND2,PCDHB8,CALHM5,TRIM22,MAOA,LMO7-AS1,AMZ1,SCN2A,TEKT4P2,LNX1,FILIP1L,ACOX2,LOC100287846,APOBEC3G,DPYD,CREB5,PPM1L,LOC107986467,TNFAIP6,FOXD2,RTN4RL1,GDF6,TMEM200A,CARD6,PELI2,CDH13,HDAC9,PCDHB7,PCDHB2,LOC105379152,MAPK10,CDH23,MAFIP,RAET1E-AS1,NLGN1,IL31RA,EPDR1,STOX2,PCDHGB2,IFITM1,LINC00537,LOC107984428,GJD3,ZNF396,FGF18,CAMK2N1,DEPP1,BTN3A3,TNFAIP2,ADAMTS15,MEGF10,RSPO2,IFI35,UBA7,NOTCH2NLC,HIC1,KALRN,PTCHD4,MEOX2,APBA2,TMOD1,NR2F1-AS1,FAM47E,LOC107987251,USP18,LOC100130992,UBE2L6,PRKCZ,CEND1,SEMA4D,N4BP2L1,GFRA1,CRTAC1,LINC02609,HACD4,PIEZO2,PSMG3-AS1,TLR3,PTPRD,FAM118A,CD40,LINC01426,CFB,LINC02202,IFI16,DDX60,NIPSNAP3B,PDE3A,LOC105376384,APOBEC3F,CCN3,FLT3LG,KIAA1671,OLFM1,PARP14,TBX4,MDK,LMCD1,ERAP2,COL18A1,GDF5,PSMB8,TWIST2,LINC00578,PCDHGA9,FRG1BP,FZD3,AKAP3,IFI30,C12orf60,CPT1C,MAPRE2,DOCK4,PDGFRB,DUSP10,ARL4C,TMEM204,CLEC3B,NEGR1,SVEP1,GASK1B,EPHA3,SOBP,VSIR,NID2,SERPING1,PID1,ECM2,NEURL2,LOC105371267,PDK3,STK17B,FBLN5,LOC100507557,PTGIR,ZNF503,LOC100233156,ATP6V1G2,LOC389834,ATRNL1,FOXP2,SLC46A3,PARP9,FGF1,AXIN2,WNT5A,KSR1,AVIL,IRX3,MBNL3,FIGN,BDNF-AS,LOC730101,GMDS-DT,DMGDH,FAM66B,YPEL3,CCNO,DAAM2,HNMT,F8A1,CDHR3,SGIP1,L3MBTL3,GLRB,LBH,ARID5B,FGD4,TMTC1,LINC01089,PCDHB15,ADA,MARCHF9,NME5,BHMT2,EDA2R,GLI3,WDFY3-AS2,CACNB4,DUSP4,HOXA1,IGFBP5,SHFL,ARL17B,IRF1-AS1,CAB39L,BMPER,DNM1P46,ALDH3A2,LOC107984203,LOC653513,LOC100499489,ROBO3,SLFN12,TBC1D8,GSAP,LRRC37A4P,EIF4E3,ADAMTS9,PCDHB9,SLC9A3-AS1,LOC112268383,EPB41L4A-AS1,OLFML2A,BRINP1,DDX58,MEF2C,LINC00649,LOC112267925,ROS1,LINC00839,SRP14-AS1,LOC107984251,DPYSL3,POPDC3,PCNX2,FAM111A-DT,GAL3ST4,YPEL2,ST8SIA1,LOC105369250,LINC01138,CC2D2A,MAP6,GOLGA6L5P,PCDHGA1,TP53TG1,USP53,PLPP3,NDN,ARHGEF35,STEAP1B,CAPN3,GHR,CSF1,SNX33,ARHGEF37,SKAP2,SPATA18,CA5B,ZNF503-AS2,ASAP3,S1PR2,APCDD1,PLXDC2,RPH3AL,CALHM2,KYAT3,RAB6B,ZEB2,RDH10,VAMP5,ARHGAP44,PDGFRA,ARHGAP42,FEZ1,ANKRD6,PARD3B,GULP1,ALDH5A1,ADAMTS1,SLC35E2A,RBMS3,DUBR,MEIS1,TRIM8,ZNF436,CDC42EP5,IDUA,KATNAL2,SUGT1P4-STRA6LP-CCDC180,SRPX2,PNMA2,NR1D1,NMI,ZNF582-AS1,SLC22A5,FLJ20021,GLIS1,CDC42EP2,ASB13,CPZ,TMEM131L,TEAD2,ACACB,LOC100996724,SCD5,LCA5,KREMEN1,CEP126,LOC155060,ZC4H2,MAML2,CD27-AS1,HECA,PCDHGA4,EPB41L2,TNS2,AGT,CEP68,RHOBTB1,SLC29A3,RARA,HEIH,LDAH,TEF,UNC93B1,PRR5,NNT-AS1,ABTB1,TRIT1,GATD3B,ME3,THNSL1,TKT,RFTN1,EVC2,NBPF3,COQ8B,ZNF862,TRAFD1,FAM50B,SNX21,TRIM13,SOCS5,TCF4,RGPD8,TMEM42,NSMF,IFIT5,PDLIM2,NOL8,CBLB,PKD2,AMOTL2,HDAC7,JMY,LINC00205,MIR100HG,MFF,ARHGAP31,PKN1,TRIM56,CRY2,TSPYL4,OGT,ZC3H7B,NUB1,PABPC4,PTEN")
stringency <- "normal"
scale_abundance <- T
scale_genes <- T
round_to <- 2
subset_genes <- T
csv_names <- F
tissue_level <- T
percent_or_count <- c("percent", "count", "both")
drop_na_row <- F
stained_gene_data <- F
tested_protein_column <- T
cancer_analysis <- "Normal"
```


The tool:
```{r}

HPAstainR <- function(gene_list, hpa_dat,
                      cancer_dat,
                      cancer_analysis = c("Normal", "Cancer", "Both"), # weight_stain = F, weight_reliability = F,
                      tissue_level = T,
                      stringency = "normal",
                      scale_abundance = T,
                      scale_genes = T, # Do not include in shiny, this is for my personal pipeline
                      round_to = 2,
                      csv_names = F,
                      stained_gene_data = T,
                      tested_protein_column = T,
                      percent_or_count = c("percent", "count", "both"),
                      drop_na_row = F) {



  # Easy way to make cancer only work, though inefficient
  cancer_only <- F
  if (cancer_analysis == "Cancer") {
    cancer_analysis <- "Both"
    cancer_only <- T
  }


  # Make gene list robust to incongruencies----------
  # test if comma seperated or non comma seperated

  if (!(str_detect(gene_list, ","))[1]) {
    gene_list <- gsub(pattern = "\\s", replacement = ",", x = gene_list)
    gene_list <- gsub(pattern = ",{2,}", replacement = ",", x = gene_list)
  }

  gene_list <- gsub(pattern = " ", replacement = "", x = gene_list)
  gene_list <- unlist(str_split(gene_list, ","))
  gene_list <- toupper(gene_list)
  p_o_c <- percent_or_count[1]

  if (tissue_level == T) {
    cell_o_tiss <- "tissue_cell"
  } else {
    cell_o_tiss <- "Cell.type"
  }


  # Remove any blanks from the gene list
  gene_list <- gene_list[gene_list != ""]


  # make new column combining cell type and tissue
  hpa_dat <- hpa_dat %>%
    mutate(Tissue = gsub("[[:digit:]]+", "", Tissue), tissue_cell = paste0(toupper(str_trim(Tissue)), " - ", Cell.type))


  # Set up all cell types for later
  all_cell_types <- unique(hpa_dat[[cell_o_tiss]])

  # Subset just to genes of interest
  sub_dat <- subset(hpa_dat, hpa_dat$Gene.name %in% gene_list)

  # Remove testis as their cell over stain and
  sub_dat <- sub_dat %>% filter(Tissue != "testis", !is.na(Cell.type), tissue_cell != "N/A - N/A")

  # Below selects the tolerance of bad data, I suggest normal or high
  if (stringency == "normal") {
    sub_dat <- subset(sub_dat, sub_dat$Reliability %in% c("Enhanced", "Supported", "Approved"))
  }

  if (stringency == "high") {
    sub_dat <- subset(sub_dat, sub_dat$Reliability %in% c("Enhanced", "Approved"))
  }

  # Test how many genes are in hpa
  percent_coding <- sum(gene_list %in% sub_dat$Gene.name) / length(gene_list)
  # What are the genes in the dataset
  prot_genes <- gene_list[(gene_list %in% sub_dat$Gene.name)]
  # What genes are not in the dataset
  non_coding <- gene_list[!(gene_list %in% sub_dat$Gene.name)]
  # Below code returns dataframe full of NAs in the case of no protein coding genes, this way you know where data is missing
  if (percent_coding == 0) {
    no_dat_matrix <- matrix(data = NA, nrow = length(all_cell_types), ncol = 7)
    rownames(no_dat_matrix) <- all_cell_types
    colnames(no_dat_matrix) <- c("High", "Medium", "Low", "Not detected", "enriched_score", "num_genes", "genes")
    no_dat_tib <- as_tibble(no_dat_matrix, rownames = "cell_type")
    return(no_dat_tib)
  }
  # CELL TYPE ENRICHMENT--------------------
  # Find levels of expression in cell types
  cell_type_dat <- table(sub_dat[[cell_o_tiss]], sub_dat$Level)
  cell_type_dat_df <- as.data.frame.matrix(cell_type_dat)
  # cell_type_dat_tiss_scale = cell_type_dat/tiss_scale
  # Normalize based on how many times they are detected
  cell_type_dat_per <- apply(cell_type_dat, 2, FUN = function(x) {
    x / rowSums(cell_type_dat)
  })
  scaled_for_genes <- rowSums(table(sub_dat[[cell_o_tiss]], sub_dat$Gene.name)) / length(prot_genes)
  # Scale for only a few genes existing
  if (scale_abundance == T) {
    # Get unique tissue counts
    uni_tiss <- sub_dat %>%
      select((!!sym(cell_o_tiss)), Tissue) %>%
      distinct() %>%
      arrange((!!sym(cell_o_tiss)))
    scaled_4_tiss_n_genes <- scaled_for_genes / rowSums(table(uni_tiss[[cell_o_tiss]], uni_tiss$Tissue))
    cell_type_dat_per <- cell_type_dat_per * scaled_4_tiss_n_genes
    # New section that fixes counts of different groups
    tiss_cell_percent <- sub_dat %>% select(Gene.name, Cell.type, tissue_cell)
    group_list <- table(tiss_cell_percent[[cell_o_tiss]])
    unique_counts <- vapply(group_list, function(x) {
      ifelse(x / length(prot_genes) > 1, (x / length(prot_genes)), 1)
    }, numeric(1))
    cell_type_dat_per <- cell_type_dat_per / unique_counts
  }


  # Below add column if the low medium or high columns don't exist--------
  if (!("Low" %in% colnames(cell_type_dat_per))) {
    Low <- matrix(0, nrow = nrow(cell_type_dat_per))
    cell_type_dat_per <- cbind(cell_type_dat_per, Low)
    colnames(cell_type_dat_per)[ncol(cell_type_dat_per)] <- "Low"
    # DF
    Low <- matrix(0, nrow = nrow(cell_type_dat_df))
    cell_type_dat_df <- cbind(cell_type_dat_df, Low)
    colnames(cell_type_dat_df)[ncol(cell_type_dat_df)] <- "Low"

    rm(Low)
  }

  if (!("Medium" %in% colnames(cell_type_dat_per))) {
    Medium <- matrix(0, nrow = nrow(cell_type_dat_per))
    cell_type_dat_per <- cbind(cell_type_dat_per, Medium)
    colnames(cell_type_dat_per)[ncol(cell_type_dat_per)] <- "Medium"

    # DF
    Medium <- matrix(0, nrow = nrow(cell_type_dat_df))
    cell_type_dat_df <- cbind(cell_type_dat_df, Medium)
    colnames(cell_type_dat_df)[ncol(cell_type_dat_df)] <- "Medium"


    rm(Medium)
  }
  if (!("High" %in% colnames(cell_type_dat_per))) {
    High <- matrix(0, nrow = nrow(cell_type_dat_per))
    cell_type_dat_per <- cbind(cell_type_dat_per, High)
    colnames(cell_type_dat_per)[ncol(cell_type_dat_per)] <- "High"
    # DF
    High <- matrix(0, nrow = nrow(cell_type_dat_df))
    cell_type_dat_df <- cbind(cell_type_dat_df, High)
    colnames(cell_type_dat_df)[ncol(cell_type_dat_df)] <- "High"

    rm(High)
  }



  # Add all missing cell types, this allows you to see what cells there is no information for--------
  # This is done below by creating a matrix of NAs of the not included cells
  not_included_cells <- all_cell_types[!(all_cell_types %in% row.names(cell_type_dat_per))]

  not_included_matrix <- matrix(data = NA, nrow = length(not_included_cells), ncol = ncol(cell_type_dat_per))

  rownames(not_included_matrix) <- not_included_cells

  cell_type_dat_per <- rbind(cell_type_dat_per, not_included_matrix)

  cell_type_dat_mat <- rbind(as.matrix(cell_type_dat_df), not_included_matrix)


  # Adding CANCER dat
  if (cancer_analysis == "Both" | cancer_analysis == "Only") {
    sub_cancer <- cancer_dat %>% filter(Gene.name %in% gene_list)

    sub_cancer <- sub_cancer %>% filter(!is.na(Cancer), !is.na(High))

    cancer_count <- sub_cancer %>%
      group_by(Cancer) %>%
      summarise(
        High = sum(High), Medium = sum(Medium), Low = sum(Low),
        `Not detected` = sum(Not.detected)
      )
    cancer_per <- cancer_count

    cancer_per[, -1] <- (cancer_count[, -1] / rowSums(cancer_count[, -1]))

    cancer_count <- as.matrix(cancer_count %>% column_to_rownames(var = "Cancer"))

    cancer_per <- as.matrix(cancer_per %>% column_to_rownames(var = "Cancer"))


    if (cancer_analysis == "Both") {
      cell_type_dat_mat <- rbind(cell_type_dat_mat, cancer_count)
      cell_type_dat_per <- rbind(cell_type_dat_per, cancer_per)
    }
  }


  # Below is where we generate the final tibble-----------------
  cell_type_out <- as_tibble(cell_type_dat_per, rownames = "cell_type") %>% # 1. Make the data a tibble with rownames as cell_type
    # dplyr::arrange(desc(High), desc(Medium), desc(Low), desc(`Not detected`)) %>% #2. No longer used step
    mutate_if(is.numeric, round, round_to) %>% # 3.
    dplyr::select(cell_type, High, Medium, Low, `Not detected`) %>% # 4
    mutate(
      enriched_score = (High * 100) + (Medium * 50) + (Low * 25),
      num_genes = sum(gene_list %in% sub_dat$Gene.name)
    ) %>%
    arrange(desc(enriched_score))


  # Prepare count data for joining
  cell_type_count <- as_tibble(cell_type_dat_mat, rownames = "cell_type") %>% rename(
    "high_expression_count" = "High",
    "medium_expression_count" = "Medium",
    "low_expression_count" = "Low",
    "not_detected_count" = "Not detected"
  )


  cell_type_out <- left_join(cell_type_out, cell_type_count, by = "cell_type")




  # Change genes in column to only those detected-------------

  # Error n here
  if (scale_genes == T) {
    prot_genes
    tiss_gene_table <- table(sub_dat[[cell_o_tiss]], sub_dat$Gene.name) > 0.5
    # CANCER
    if (cancer_analysis == "Both") {
      cancer_gene_table <- as.matrix(table(sub_cancer$Cancer, sub_cancer$Gene.name) > 0.5)
      # Make it robust for non matching
      if (ncol(tiss_gene_table) != ncol(cancer_gene_table)) {
        not_shared_normal <- colnames(cancer_gene_table)[!(colnames(cancer_gene_table) %in% colnames(tiss_gene_table))]
        not_shared_cancer <- colnames(tiss_gene_table)[!(colnames(tiss_gene_table) %in% colnames(cancer_gene_table))]

        norm_add_matrix <- matrix(data = FALSE, nrow = nrow(tiss_gene_table), ncol = length(not_shared_normal))
        colnames(norm_add_matrix) <- not_shared_normal
        tiss_gene_table <- (cbind(tiss_gene_table, norm_add_matrix))


        cancer_add_matrix <- matrix(data = FALSE, nrow = nrow(cancer_gene_table), ncol = length(not_shared_cancer))
        colnames(cancer_add_matrix) <- not_shared_cancer
        cancer_gene_table <- (cbind(cancer_gene_table, cancer_add_matrix))
      }

      tiss_gene_table <- rbind(tiss_gene_table, cancer_gene_table)
    }

    cell_types_current <- cell_type_out$cell_type

    gene_col <- NULL
    gene_count <- NULL
    for (cells_in in cell_types_current) {

      # Add grouped or split gene option here


      # cells_in <- "chondrocytes"
      if (cells_in %in% rownames(tiss_gene_table)) {
        temp_genes <- names(tiss_gene_table[cells_in, ])[tiss_gene_table[cells_in, ] == T]
        gene_col <- c(gene_col, paste0(temp_genes, collapse = ", "))
        gene_count <- c(gene_count, length(temp_genes))
      } else {
        gene_col <- c(gene_col, "")
        gene_count <- c(gene_count, 0)
      }
    }
  }

  if (scale_genes == T) {
    cell_type_out$genes <- as.vector(gene_col)
    cell_type_out$num_genes <- gene_count
  } else {
    cell_type_out$genes <- paste0(prot_genes, collapse = ", ")
  }


  # Add the option that gives a column if a gene is availavble

  #Tissue level determines if the analysis looks at cell types on a tissue level instead of a general level------
  #This is ideal as cell types in different tissues, though similiar, have different profiles. 
  if (tissue_level == T) {
    staining_dat <- sub_dat %>% filter(Level != "Not detected")
    staining_tf_df <- as.matrix.data.frame(table(staining_dat$tissue_cell, staining_dat$Gene.name) > 0, T)
    colnames(staining_tf_df) <- colnames(table(staining_dat$tissue_cell, staining_dat$Gene.name))
    staining_tf_df <- as.data.frame(staining_tf_df)

    # CANCER
    if (cancer_analysis == "Both" | cancer_analysis == "Only") {
      cancer_staining_dat <- sub_cancer %>% filter(High > 0 | Low > 0 | Medium > 0)
      cancer_staining_tf_df <- as.matrix.data.frame(table(cancer_staining_dat$Cancer, cancer_staining_dat$Gene.name) > 0, T)
      colnames(cancer_staining_tf_df) <- colnames(table(cancer_staining_dat$Cancer, cancer_staining_dat$Gene.name))
      cancer_staining_tf_df <- as.data.frame(cancer_staining_tf_df)
      # put in blank information
      false_cols <- colnames(staining_tf_df[!(colnames(staining_tf_df) %in% colnames(cancer_staining_tf_df))])
      # make false_matrix
      false_matrix <- matrix(data = FALSE, ncol = length(false_cols), nrow = nrow(cancer_staining_tf_df))
      colnames(false_matrix) <- false_cols
      cancer_staining_tf_df <- cbind(cancer_staining_tf_df, false_matrix)
      which(colnames(cancer_staining_tf_df) %in% colnames(staining_tf_df))
      # Reorder
      new_order <- match(colnames(staining_tf_df), colnames(cancer_staining_tf_df))
      cancer_staining_tf_df <- cancer_staining_tf_df[, new_order]

      if (cancer_analysis == "Both") {
        staining_tf_df <- rbind(staining_tf_df, cancer_staining_tf_df)
      }
    }
    # Cancer end
  } else {
    staining_dat <- sub_dat %>% filter(Level != "Not detected")
    staining_tf_df <- as.matrix.data.frame(table(staining_dat$Cell.type, staining_dat$Gene.name) > 0, T)
    colnames(staining_tf_df) <- colnames(table(staining_dat$Cell.type, staining_dat$Gene.name))
    staining_tf_df <- as.data.frame(staining_tf_df)

    # CANCER
    if (cancer_analysis == "Both" | cancer_analysis == "Only") {
      cancer_staining_dat <- sub_cancer %>% filter(High > 0 | Low > 0 | Medium > 0)
      cancer_staining_tf_df <- as.matrix.data.frame(table(cancer_staining_dat$Cancer, cancer_staining_dat$Gene.name) > 0, T)
      colnames(cancer_staining_tf_df) <- colnames(table(cancer_staining_dat$Cancer, cancer_staining_dat$Gene.name))
      cancer_staining_tf_df <- as.data.frame(cancer_staining_tf_df)
      # put in blank information
      false_cols <- colnames(staining_tf_df[!(colnames(staining_tf_df) %in% colnames(cancer_staining_tf_df))])
      # make false_matrix
      false_matrix <- matrix(data = FALSE, ncol = length(false_cols), nrow = nrow(cancer_staining_tf_df))
      colnames(false_matrix) <- false_cols
      cancer_staining_tf_df <- cbind(cancer_staining_tf_df, false_matrix)
      which(colnames(cancer_staining_tf_df) %in% colnames(staining_tf_df))
      # Reorder
      new_order <- match(colnames(staining_tf_df), colnames(cancer_staining_tf_df))
      cancer_staining_tf_df <- cancer_staining_tf_df[, new_order]

      if (cancer_analysis == "Both") {
        staining_tf_df <- rbind(staining_tf_df, cancer_staining_tf_df)
      }
    }
    # cancer end
  }

  # For loop to replace T F with name
  for (col_n in 1:ncol(staining_tf_df)) {
    gene <- colnames(staining_tf_df)[col_n]
    staining_tf_df[, col_n] <- ifelse(staining_tf_df[, col_n] == T, gene, "")

  }


  stained_list <- apply(as.matrix(staining_tf_df), 1, paste, collapse = ",")
  # Remove all , at the end of strings
  while (sum(str_detect(string = stained_list, pattern = ",$")) > 0) {
    stained_list <- gsub(pattern = ",$", x = stained_list, replacement = "")
  }

  # Remove all , at beginning
  while (sum(str_detect(string = stained_list, pattern = "^,")) > 0) {
    stained_list <- gsub(pattern = "^,", x = stained_list, replacement = "")
  }

  # Remove all ,, and replace with ,
  while (sum(str_detect(string = stained_list, pattern = ",,")) > 0) {
    stained_list <- gsub(pattern = ",,", x = stained_list, replacement = ",")
  }

  stained_list <- gsub(",", ", ", stained_list)

  stained_out <- as.data.frame(stained_list, stringsAsFactors = F) %>% rownames_to_column(var = "cell_type")

  cell_type_out <- left_join(cell_type_out, stained_out, by = "cell_type")
  # }


  # move stained out into upper list



  # Only cancer

  if (cancer_only == T) {
    cell_type_out <- cell_type_out %>% filter(cell_type %in% cancer_dat$Cancer)
  }


  ### CHI TEST HERE -------------
  # Insert chi square test here, first normal data, then cancer, then both Make sure to csv names
  # filter cell type out to remove NAs


  # Remove NAs and Testis as we don't use it
  ubi_test <- hpa_dat %>%
    mutate(
      stained = ifelse(Level != "Not detected", T, F),
      in_list = ifelse(Gene.name %in% gene_list, T, F)
    ) %>%
    filter(Tissue != "testis", !is.na(Cell.type), tissue_cell != "N/A - N/A")
  # Get a list of tested genes
  genes_tested <- table(ubi_test$Gene.name)
  # Filter down to stained genes
  ubi_test_filt <- ubi_test %>% filter(stained == T)
  # Make  a table of stained proteins by cell -tisssue
  ubi_table <- table(ubi_test_filt$tissue_cell, ubi_test_filt$Gene.name)
  # Now just remove non-matching proteins
  ubi_table_filt <- ubi_table[, colnames(ubi_table) %in% rownames(genes_tested)]
  genes_tested_filt <- genes_tested[rownames(genes_tested) %in% colnames(ubi_table_filt)]
  # Create the out object which is a ratio of those stained over those tested
  out <- (colSums(ubi_table_filt) / as.vector(genes_tested_filt))
  # Cut the data down to rare genes found in less thant the 1st quartile
  # quart_ind <- out[out <= quantile(out, .25)]
  quart_ind <- out[out <= quantile(out, .15)]

  ### The Chi Square calculation
  # Make quart hpa from sub hpa, necessary?

  # testing switching ubi test for sub hpa



  quart_hpa <- ubi_test %>% filter(Gene.name %in% names(quart_ind))

  # Not 2 levels is used to remove cell types that fail to have two levels in the gene list
  not_2_levels <- quart_hpa %>%
    group_by(tissue_cell) %>%
    summarize(stain_mean = mean(stained), list_mean = mean(in_list)) %>%
    filter(stain_mean == 1 | stain_mean == 0 | list_mean == 1 | list_mean == 0)

  # filter down to top specificity genes
  quart_hpa <- quart_hpa %>% filter(!(tissue_cell %in% not_2_levels$tissue_cell))
  # The chi test

  if (nrow(quart_hpa) != 0) {
    chi_out <- quart_hpa %>%
      group_by(tissue_cell) %>%
      summarise(p_val = chisq.test(stained, in_list, simulate.p.value = T)$p.value) %>%
      rename(cell_type = tissue_cell)
    chi_out$p_val_adj <- p.adjust(chi_out$p_val)
  }

  if (exists("chi_out")) {
    if (cancer_analysis == "Normal") {
      cell_type_out <- left_join(cell_type_out, chi_out, by = "cell_type")
    } else {
      chi_out_tiss <- chi_out
    }
  }

  #### CHI SQUARE CANCER ANALYSIS---------
  if (cancer_analysis == "Both" | cancer_analysis == "Only") {
    sub_cell_type <- cell_type_out %>% filter(!(is.na(high_expression_count)))
    #
    sub_canc <- cancer_dat %>%
      filter(Cancer %in% (sub_cell_type$cell_type)) %>%
      unique()

    sub_canc <- sub_canc %>% mutate(
      stained = ifelse(Not.detected != 0, T, F),
      in_list = ifelse(Gene.name %in% gene_list, T, F)
    ) # %>%
    # filter(!(is.na(stained)))

    # Remove NAs and Testis as we don't use it
    ubi_test <- cancer_dat %>% mutate(
      stained = ifelse(Not.detected != 0, T, F),
      in_list = ifelse(Gene.name %in% gene_list, T, F)
    )
    # Get a list of tested genes
    genes_tested <- table(ubi_test$Gene.name)
    # Filter down to stained genes
    ubi_test_filt <- ubi_test %>% filter(stained == T)
    # Make  a table of stained proteins by cell -tisssue
    ubi_table <- table(ubi_test_filt$Cancer, ubi_test_filt$Gene.name)
    # Now just remove non-matching proteins
    ubi_table_filt <- ubi_table[, colnames(ubi_table) %in% rownames(genes_tested)]
    genes_tested_filt <- genes_tested[rownames(genes_tested) %in% colnames(ubi_table_filt)]
    # Create the out object which is a ratio of those stained over those tested
    out <- (colSums(ubi_table_filt) / as.vector(genes_tested_filt))
    # Cut the data down to rare genes found in less thant the 1st quartile
    # quart_ind <- out[out <= quantile(out, .25)]
    quart_ind <- out[out <= quantile(out, .15)]


    quart_canc <- ubi_test %>% filter(Gene.name %in% names(quart_ind))

    # Not 2 levels is used to remove cell types that fail to have two levels in the gene list
    not_2_levels <- quart_canc %>%
      filter(!is.na(stained)) %>%
      group_by(Cancer) %>%
      summarize(stain_mean = mean(stained), list_mean = mean(in_list)) %>%
      filter(stain_mean == 1 | stain_mean == 0 | list_mean == 1 | list_mean == 0)

    # filter down to top specificity genes
    quart_canc <- quart_canc %>% filter(!(Cancer %in% not_2_levels$Cancer))
    # The chi test
    # chi_out <- quart_canc %>% group_by(Cancer) %>%
    #   summarise(p_val =chisq.test(stained, in_list, simulate.p.value = T)$p.value) %>%
    #   rename(cell_type = Cancer)
    #
    # chi_out$p_val_adj <- p.adjust(chi_out$p_val)

    if (nrow(quart_canc) != 0) {
      chi_out <- quart_canc %>%
        group_by(Cancer) %>%
        summarise(p_val = chisq.test(stained, in_list, simulate.p.value = T)$p.value) %>%
        rename(cell_type = Cancer)

      chi_out$p_val_adj <- p.adjust(chi_out$p_val)
    }



    if (cancer_analysis == "Both") {
      chi_out <- bind_rows(chi_out_tiss, chi_out)

      cell_type_out <- left_join(cell_type_out, chi_out, by = "cell_type")
    } else {
      cell_type_out <- left_join(cell_type_out, chi_out, by = "cell_type")
    }
  }

  # Fixing Pvalues-------------
  # In case no pvals
  if (!("p_val" %in% colnames(cell_type_out))) {
    cell_type_out <- cell_type_out %>% mutate(
      p_val = 1,
      p_val_adj = 1
    )
  }

  cell_type_out <- cell_type_out %>% mutate(
    p_val = format.pval(p_val, round_to, .005),
    p_val_adj = format.pval(p_val_adj, round_to, .005)
  )

  # Change names-----------------
  if (csv_names == T) {
    cell_type_out <- cell_type_out %>% select(cell_type,
      percent_high_expression = High,
      high_expression_count,
      percent_medium_expression = Medium,
      medium_expression_count,
      percent_low_expression = Low,
      low_expression_count,
      percent_not_detected = `Not detected`,
      not_detected_count,
      number_of_proteins = num_genes,
      tested_proteins = genes,
      detected_proteins = stained_list,
      everything()
    )
  }

  if (csv_names == F) {
    cell_type_out <- cell_type_out %>% select(
      `Cell Type` = cell_type,
      `Percent High Expression` = High,
      `High Expression Count` = high_expression_count,
      `Percent Medium Expression` = Medium,
      `Medium Expression Count` = medium_expression_count,
      `Percent Low Expression` = Low,
      `Low Expression Count` = low_expression_count,
      `Percent Not Detected` = `Not detected`,
      `Not Detected Count` = not_detected_count,
      `Number of Proteins` = num_genes,
      `Enriched Score` = enriched_score,
      `Tested Proteins` = genes,
      `Detected Proteins` = stained_list,
      `P-Value` = p_val,
      `P-Value Adjusted` = p_val_adj,
      everything()
    )
  }
  
  # Select count percent preference---------------------
  if (p_o_c == "percent") {
    cell_type_out <- cell_type_out[, -grep("ount", colnames(cell_type_out))]
  }

  if (p_o_c == "count") {
    cell_type_out <- cell_type_out[, -grep("ercent", colnames(cell_type_out))]
  }


  if (drop_na_row == T) {
    cell_type_out <- cell_type_out %>% drop_na()
  }

  # Simplify stained list drop
  if (stained_gene_data == F) {
    cell_type_out <- cell_type_out[, -grep("ected", colnames(cell_type_out))]
  }
  if (tested_protein_column == F) {
    cell_type_out <- cell_type_out[, -grep("ested", colnames(cell_type_out))]
  }


  #Returning final table -------------
  return((cell_type_out))
}

```


Test tool
```{r}
options(warn = -1)
gene_list <- c("PRSS1", "CLPS", "PNLIP", "CELA3A", "PRL")

# gene_list <- "PECAM1"

stainr_out <- HPAstainR(
  gene_list = gene_list,
  cancer_dat = cancer_dat,
  hpa_dat = hpa_dat,
  tissue_level = T,
  round_to = 4,
  cancer_analysis = "Both",
  stained_gene_data = F,
  tested_protein_column = F,
  csv_names = T
)

stainr_out

write.csv(stainr_out, file = "stainR_both_current_output.csv", row.names = F)
```

Trouble shooting

New idea, make it have either a "General" output which is all cells lump together or "tissue based" output which gives results for tissue - cell types
```{r}
hpa_dat

sub_dat <- sub_dat %>% mutate(Tissue = gsub("[[:digit:]]+", "", Tissue), tissue_cell = paste0(toupper(str_trim(Tissue)), "-", Cell.type))


table(sub_dat$tissue_cell, sub_dat$Level)
table(sub_dat$tissue_cell)


# cell_o_tiss <- "Cell.type"

cell_o_tiss <- "tissue_cell"

# Cell tiss test
tiss_cell_percent_test <- sub_dat %>% select(Gene.name, Cell.type, tissue_cell)

test_list <- table(tiss_cell_percent_test[[cell_o_tiss]])

sapply(test_list, function(x) {
  ifelse(x / length(prot_genes) > 1, (x / length(prot_genes)), 1)
})

# official naming
tiss_cell_percent <- sub_dat %>% select(Gene.name, Cell.type, tissue_cell)

group_list <- table(tiss_cell_percent[[cell_o_tiss]])

unique_counts <- sapply(group_list, function(x) {
  ifelse(x / length(prot_genes) > 1, (x / length(prot_genes)), 1)
})
```

Making the chi-squared
```{r}
hpa_summ

total_prot_t <- hpa_summ$total_prot[1]
all_detected_t <- hpa_summ$all_detected[1]
stained_prot_t <- hpa_summ$stained_prot[1]
missing_prot_t <- hpa_summ$missing_prot[1]

rbind(
  c(total_prot_t, all_detected_t),
  c(total_prot_t, all_detected_t)
)



#### CUrr chi code
sub_cell_type <- cell_type_count %>% filter(!(is.na(high_expression_count)))

sub_hpa <- hpa_dat %>%
  filter(tissue_cell %in% (sub_cell_type$cell_type)) %>%
  unique()

sub_hpa <- sub_hpa %>% mutate(
  stained = ifelse(Gene.name %in% gene_list & Level != "Not detected", T, F),
  stained_2 = ifelse(Level != "Not detected", T, F),
  in_list = ifelse(Gene.name %in% gene_list, T, F)
)

hpa_summ <- sub_hpa %>%
  group_by(tissue_cell) %>%
  summarise(
    total_prot = n(),
    all_detected = sum(!(Level %in% "Not detected")),
    stained_prot = sum(stained),
    missing_prot = length(gene_list) - stained_prot
  )

hpa_chi <- sub_hpa %>%
  group_by(tissue_cell) %>%
  distinct(tissue_cell, in_list, stained_2) %>%
  summarise_all(funs(chisq.test(
    sub_hpa$in_list,
    sub_hpa$stained_2, simulate.p.value
  )$p.value))





### As they want it

sub_hpa %>%
  group_by(tissue_cell) %>%
  summarise(p_val = chisq.test(stained_2, in_list)$p.value)


test_panc <- sub_hpa %>% filter(tissue_cell %in% "PANCREAS - exocrine glandular cells")

chi_out <- chisq.test(test_panc$stained_2, test_panc$in_list)

chi_out

chi_out$expected

addmargins(table(test_panc$stained_2, test_panc$in_list))


### Anotehr tissue


test_mac <- sub_hpa %>% filter(tissue_cell %in% "LUNG - macrophages")

chi_out <- chisq.test(test_mac$stained_2, test_mac$in_list)

chi_out

chi_out$expected

addmargins(table(test_mac$stained_2, test_mac$in_list))
```

What proteins are ubiquitous
```{r}
ubi_test <- hpa_dat %>%
  mutate(stained = ifelse(Level != "Not detected", T, F)) %>%
  filter(Tissue != "testis", !is.na(Cell.type), tissue_cell != "N/A - N/A")

genes_tested <- table(ubi_test$Gene.name)

ubi_test_filt <- ubi_test %>% filter(stained == T)

ubi_table <- table(ubi_test_filt$tissue_cell, ubi_test_filt$Gene.name)

ubi_table[1:3, 1:3]

ubi_table_filt <- ubi_table[, colnames(ubi_table) %in% rownames(genes_tested)]
genes_tested_filt <- genes_tested[rownames(genes_tested) %in% colnames(ubi_table_filt)]

out <- (colSums(ubi_table_filt) / as.vector(genes_tested_filt))


median_ind <- out[out <= median(out)]

quart_ind <- out[out <= summary(out)[2]]

#### Sub HPA with median

median_hpa <- sub_hpa %>% filter(Gene.name %in% names(median_ind))

test_panc <- median_hpa %>% filter(tissue_cell %in% "PANCREAS - exocrine glandular cells")

chi_out <- chisq.test(test_panc$stained_2, test_panc$in_list)

chi_out

chi_out$expected

addmargins(table(test_panc$stained_2, test_panc$in_list))

#### Sub HPA with median

quart_hpa <- sub_hpa %>% filter(Gene.name %in% names(quart_ind))

test_panc <- quart_hpa %>% filter(tissue_cell %in% "PANCREAS - exocrine glandular cells")

chi_out <- chisq.test(test_panc$stained_2, test_panc$in_list)

chi_out

chi_out$expected

addmargins(table(test_panc$stained_2, test_panc$in_list))


### Anotehr tissue


test_mac <- quart_hpa %>% filter(tissue_cell %in% "LUNG - pneumocytes")

chi_out <- chisq.test(test_mac$stained_2, test_mac$in_list)

chi_out

chi_out$expected

addmargins(table(test_mac$stained_2, test_mac$in_list))


## All

# I need to make sure there are two levels

not_2_levels <- quart_hpa %>%
  group_by(tissue_cell) %>%
  summarize(stain_mean = mean(stained_2), list_mean = mean(in_list)) %>%
  filter(stain_mean == 1 | stain_mean == 0 | list_mean == 1 | list_mean == 0)

quart_hpa <- quart_hpa %>% filter(!(tissue_cell %in% not_2_levels$tissue_cell))

chi_out <- quart_hpa %>%
  group_by(tissue_cell) %>%
  summarise(p_val = chisq.test(stained_2, in_list)$p.value)


chi_out$p_val_adj <- p.adjust(chi_out$p_val)

chi_out %>% arrange((p_val))

chi_out <- not_2_levels %>%
  mutate(p_val = 1, p_val_adj = 1) %>%
  select(tissue_cell, p_val, p_val_adj) %>%
  bind_rows(chi_out)


for (cell_type in unique(quart_hpa$tissue_cell)) {
  temp_dat <- filter(quart_hpa, tissue_cell %in% cell_type)
  chisq.test(temp_dat$stained_2, temp_dat$in_list)
}



#### Removed sections


sub_hpa <- sub_hpa %>% mutate(
  stained = ifelse(Gene.name %in% gene_list & Level != "Not detected", T, F),
  stained = ifelse(Level != "Not detected", T, F),
  in_list = ifelse(Gene.name %in% gene_list, T, F)
)
hpa_summ <- sub_hpa %>%
  group_by(tissue_cell) %>%
  summarise(
    total_prot = n(),
    all_detected = sum(!(Level %in% "Not detected")),
    stained_prot = sum(stained),
    missing_prot = length(gene_list) - stained_prot
  )

########## sticking all the work parts together


# Setting up of Sub HPA
# Get the specific cell types that will be used
sub_cell_type <- cell_type_count %>% filter(!(is.na(high_expression_count)))
#
sub_hpa <- hpa_dat %>%
  filter(tissue_cell %in% (sub_cell_type$cell_type)) %>%
  unique()

sub_hpa <- sub_hpa %>% mutate(
  stained = ifelse(Level != "Not detected", T, F),
  in_list = ifelse(Gene.name %in% gene_list, T, F)
)

# quart_hpa <- sub_hpa %>% filter(Gene.name %in% names(quart_ind))


# Remove NAs and Testis as we don't use it
ubi_test <- hpa_dat %>%
  mutate(
    stained = ifelse(Level != "Not detected", T, F),
    in_list = ifelse(Gene.name %in% gene_list, T, F)
  ) %>%
  filter(Tissue != "testis", !is.na(Cell.type), tissue_cell != "N/A - N/A")
# Get a list of tested genes
genes_tested <- table(ubi_test$Gene.name)
# Filter down to stained genes
ubi_test_filt <- ubi_test %>% filter(stained == T)
# Make  a table of stained proteins by cell -tisssue
ubi_table <- table(ubi_test_filt$tissue_cell, ubi_test_filt$Gene.name)
# Now just remove non-matching proteins
ubi_table_filt <- ubi_table[, colnames(ubi_table) %in% rownames(genes_tested)]
genes_tested_filt <- genes_tested[rownames(genes_tested) %in% colnames(ubi_table_filt)]
# Create the out object which is a ratio of those stained over those tested
out <- (colSums(ubi_table_filt) / as.vector(genes_tested_filt))
# Cut the data down to rare genes found in less thant the 1st quartile
quart_ind <- out[out <= summary(out)[2]]

### The Chi Square calculation
# Make quart hpa from sub hpa, necessary?

# testing switching ubi test for sub hpa



quart_hpa <- ubi_test %>% filter(Gene.name %in% names(quart_ind))

# Not 2 levels is used to remove cell types that fail to have two levels in the gene list
not_2_levels <- quart_hpa %>%
  group_by(tissue_cell) %>%
  summarize(stain_mean = mean(stained), list_mean = mean(in_list)) %>%
  filter(stain_mean == 1 | stain_mean == 0 | list_mean == 1 | list_mean == 0)

# filter down to top specificity genes
quart_hpa <- quart_hpa %>% filter(!(tissue_cell %in% not_2_levels$tissue_cell))
# The chi test
chi_out <- quart_hpa %>%
  group_by(tissue_cell) %>%
  summarise(p_val = chisq.test(stained, in_list)$p.value) %>%
  rename(cell_type = tissue_cell)

chi_out$p_val_adj <- p.adjust(chi_out$p_val)

# chi_out %>% arrange((p_val))
# Re-add lost
# chi_out <- not_2_levels %>% mutate(p_val = 1, p_val_adj = 1) %>% select(tissue_cell, p_val, p_val_adj) %>% bind_rows(chi_out) %>%
#            rename(cell_type = tissue_cell)



cell_type_count <- left_join(cell_type_count, chi_out)
```

Redo above with cancer
```{r}
cancer_dat
sub_cell_type <- cell_type_count %>% filter(!(is.na(high_expression_count)))
#
sub_canc <- cancer_dat %>%
  filter(Cancer %in% (sub_cell_type$cell_type)) %>%
  unique()

sub_canc <- sub_canc %>% mutate(
  stained = ifelse(Not.detected != 0, T, F),
  in_list = ifelse(Gene.name %in% gene_list, T, F)
) # %>%
# filter(!(is.na(stained)))

# Remove NAs and Testis as we don't use it
ubi_test <- cancer_dat %>% mutate(
  stained = ifelse(Not.detected != 0, T, F),
  in_list = ifelse(Gene.name %in% gene_list, T, F)
)
# Get a list of tested genes
genes_tested <- table(ubi_test$Gene.name)
# Filter down to stained genes
ubi_test_filt <- ubi_test %>% filter(stained == T)
# Make  a table of stained proteins by cell -tisssue
ubi_table <- table(ubi_test_filt$Cancer, ubi_test_filt$Gene.name)
# Now just remove non-matching proteins
ubi_table_filt <- ubi_table[, colnames(ubi_table) %in% rownames(genes_tested)]
genes_tested_filt <- genes_tested[rownames(genes_tested) %in% colnames(ubi_table_filt)]
# Create the out object which is a ratio of those stained over those tested
out <- (colSums(ubi_table_filt) / as.vector(genes_tested_filt))
# Cut the data down to rare genes found in less thant the 1st quartile
quart_ind <- out[out <= summary(out)[2]]



quart_canc <- ubi_test %>% filter(Gene.name %in% names(quart_ind))

# Not 2 levels is used to remove cell types that fail to have two levels in the gene list
not_2_levels <- quart_canc %>%
  filter(!is.na(stained)) %>%
  group_by(Cancer) %>%
  summarize(stain_mean = mean(stained), list_mean = mean(in_list)) %>%
  filter(stain_mean == 1 | stain_mean == 0 | list_mean == 1 | list_mean == 0)

# filter down to top specificity genes
quart_canc <- quart_canc %>% filter(!(Cancer %in% not_2_levels$Cancer))
# The chi test
if (nrow(quart_canc) != 0) {
  chi_out <- quart_canc %>%
    group_by(Cancer) %>%
    summarise(p_val = chisq.test(stained, in_list)$p.value) %>%
    rename(cell_type = Cancer)
}
chi_out$p_val_adj <- p.adjust(chi_out$p_val)

cell_type_count <- left_join(cell_type_count, chi_out)


supp_table <- as.data.frame(out) %>%
  rownames_to_column(var = "proteins") %>%
  mutate(rare = ifelse(out < quantile(out, .25), "yes", "no")) %>%
  rename(stained_per_tested = out)

write.csv(supp_table, "rare_protein_list.csv", row.names = F)
```



Test gene lists
```{r}
gene_list <- c(
  "MTND1P23",
  "MFSD2A",
  "CHIAP2",
  "CHIA",
  "TNR",
  "SLC26A9",
  "PIGR",
  "C4BPA",
  "SFTPB",
  "AC008268.1",
  "SCN1A",
  "LRP2",
  "CCL20",
  "SLC6A20",
  "LAMP3",
  "FGFBP1",
  "HHIP",
  "FGA",
  "FGG",
  "F11",
  "DPCR1",
  "PGC",
  "ADGRF1",
  "ROS1",
  "LGI3",
  "SFTPC",
  "RP11-238K6.1",
  "RP11-408O19.5",
  "HKDC1",
  "SFTPA2",
  "SFTPA1",
  "SFTPD",
  "ANKRD1",
  "CRTAC1",
  "DMBT1",
  "ABCC8",
  "SAA1",
  "ELF5",
  "RND1",
  "SLC5A8",
  "FREM2",
  "CPB2",
  "PLA2G4F",
  "RASGRF1",
  "IRX6",
  "ALOX15B",
  "KRT16P2",
  "CSF3",
  "FUT3",
  "CXCL17",
  "NAPSA",
  "HAS1",
  "PCSK2",
  "LL22NC03-N95F10.1",
  "PLA2G3",
  "AGTR2",
  "SLC6A14"
)
```

Diagram of out and cut off
```{r}
ggplot() +
  geom_histogram(aes(x = out), fill = "white", color = "black") +
  geom_vline(xintercept = summary(out)[2], color = "red", linetype = "dashed", size = 1.5) +
  labs(title = "Histogram representing the distribution of stained:tested protein ratio", subtitle = "Dashed line indicates 1st quartile") +
  xlab("stained:tested protein ratio")
```

How long it takes to run
```{r}
start_time <- Sys.time()
HPAStainR(gene_list, hpa_dat, cancer_dat)
end_time <- Sys.time()

end_time - start_time

####


start_time <- Sys.time()
HPAStainR(gene_list, hpa_dat, cancer_dat, cancer_analysis = "both")
end_time <- Sys.time()

end_time - start_time
```

